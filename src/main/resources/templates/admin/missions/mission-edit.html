<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      th:replace="~{admin/layout :: layout('제목', ~{::content}, ~{::scripts})}">
<body>
<div th:fragment="content">

    <div class="page-header">
        <h2>미션 수정</h2>
        <a th:href="@{/admin/missions}" class="btn-third">← 돌아가기</a>
    </div>

    <div class="admin-form">

        <input type="hidden" id="missionId" th:value="${mission.id}"/>

        <div class="card">

            <div class="form-group">
                <label>미션 타입</label>
                <div class="readonly-text" th:text="${mission.type}"></div>
            </div>

            <div class="form-group">
                <label>내용</label>
                <input id="content" type="text" th:value="${mission.content}"/>
            </div>

            <div class="form-group">
                <label>포인트</label>
                <input id="point" type="number" th:value="${mission.point}"/>
            </div>

            <div class="form-group" id="distanceField" th:if="${mission.type.name() == 'WALK_DISTANCE'}">
                <label>목표 거리 (m)</label>
                <input id="targetDistance" type="number" th:value="${mission.targetDistance}"/>
            </div>

            <div class="form-group" id="timeField" th:if="${mission.type.name() == 'WALK_TIME'}">
                <label>목표 시간 (초)</label>
                <input id="targetTime" type="number" th:value="${mission.targetTime}"/>
            </div>

        </div>

        <div class="actions">
            <button class="btn-third btn-lg" type="button"
                    onclick="window.location.href='/admin/missions'">취소
            </button>
            <button class="btn-primary btn-lg" type="button" onclick="updateMission()">수정 완료</button>
        </div>

    </div>

</div>

<div th:fragment="scripts">
    <script>
    async function updateMission() {
        const id = document.getElementById("missionId").value;

        const type = document.querySelector(".readonly-text").innerText.trim();

        const payload = {
            type: type,
            content: document.getElementById("content").value,
            point: parseInt(document.getElementById("point").value)
        };

        if (type === "WALK_DISTANCE") {
            payload.targetDistance = parseInt(document.getElementById("targetDistance").value);
        }

        if (type === "WALK_TIME") {
            payload.targetTime = parseInt(document.getElementById("targetTime").value);
        }

        const res = await fetch('/api/admin/missions/' + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert('미션이 수정되었습니다.');
            window.location.href = '/admin/missions';
        } else {
            alert('수정 실패 — 서버 로그 확인 바랍니다.');
        }
    }
    </script>
</div>

</body>
</html>
