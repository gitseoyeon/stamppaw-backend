<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>뱃지 관리</title>

    <!-- Stamppaw 관리자 전용 CSS -->
    <link rel="stylesheet" th:href="@{/css/admin.css}"/>

    <style>
        /* 2단 레이아웃 */
        .container {
            display: flex;
            gap: 24px;
            padding: 20px 24px;
        }

        .left-panel {
            width: 32%;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .right-panel {
            width: 68%;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        /* 카드 모듈 재사용 */
        .panel-card {
            background: #fff;
            border: 1px solid #eee;
            padding: 18px;
            border-radius: 8px;
        }

        .inline-image {
            width: 38px;
            height: 38px;
            border-radius: 6px;
            object-fit: cover;
        }

        /* action 버튼 묶음 */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
        }
    </style>

    <script>
        function filterFields(entityId, fieldId) {
            const entity = document.getElementById(entityId)?.value;
            const field = document.getElementById(fieldId);

            if (!entity || !field) return;

            for (let option of field.options) {
                const group = option.getAttribute("data-entities");
                option.style.display = group.includes(entity) ? "block" : "none";
            }
        }
    </script>
</head>

<body>

<!-- 2단 구조 컨테이너 -->
<div class="container">

    <!-- 왼쪽 패널 : 새 뱃지 생성 / 수정 패널 -->
    <div class="left-panel">
        <div class="panel-card">

            <div class="section-title">
                <h3 th:if="${editId == null}">새 뱃지 생성</h3>
                <h3 th:if="${editId != null}">뱃지 수정 (#<span th:text="${editId}"></span>)</h3>
            </div>

            <form th:action="${editId == null} ? @{/admin/badges} : @{/admin/badges/{id}(id=${editId})}"
                  method="post"
                  enctype="multipart/form-data"
                  th:object="${formRequest}"
                  class="admin-form">

                <div class="grid-2">

                    <!-- Badge Code -->
                    <div class="col-span-2">
                        <label>Badge Code</label>
                        <input type="text" th:field="*{badgeCode}">
                    </div>

                    <!-- 이름 -->
                    <div class="col-span-2">
                        <label>Name</label>
                        <input type="text" th:field="*{name}">
                    </div>

                    <!-- 설명 -->
                    <div class="col-span-2">
                        <label>Description</label>
                        <input type="text" th:field="*{description}">
                    </div>

                    <!-- 아이콘 업로드 -->
                    <div class="col-span-2">
                        <label>Icon Upload</label>
                        <input type="file" th:field="*{icon}">
                    </div>

                    <!-- Rule Type -->
                    <div class="col-span-2">
                        <label>Rule Type</label>
                        <select th:field="*{ruleType}">
                            <option th:each="t : ${T(org.example.stamppaw_backend.badge.entity.RuleType).values()}"
                                    th:value="${t}" th:text="${t}">
                            </option>
                        </select>
                    </div>

                    <!-- Target Entity -->
                    <div>
                        <label>Target Entity</label>
                        <select id="entitySelect" th:field="*{targetEntity}"
                                onchange="filterFields('entitySelect','fieldSelect')">
                            <option th:each="e : ${T(org.example.stamppaw_backend.badge.entity.TargetEntity).values()}"
                                    th:value="${e}" th:text="${e}">
                            </option>
                        </select>
                    </div>

                    <!-- Target Field -->
                    <div>
                        <label>Target Field</label>
                        <select id="fieldSelect" th:field="*{targetField}">
                            <option th:each="f : ${T(org.example.stamppaw_backend.badge.entity.TargetField).values()}"
                                    th:value="${f}"
                                    th:text="${f}"
                                    th:attr="data-entities=${f.applicableEntities}">
                            </option>
                        </select>
                    </div>

                    <!-- Threshold -->
                    <div class="col-span-2">
                        <label>Threshold</label>
                        <input type="number" th:field="*{threshold}">
                    </div>
                </div>

                <!-- 버튼 -->
                <div class="actions">
                    <button class="btn-primary btn-lg" type="submit"
                            th:text="${editId == null ? '생성' : '저장'}"></button>

                    <a th:if="${editId != null}" th:href="@{/admin/badges}" class="btn-third btn-lg">
                        취소
                    </a>
                </div>

            </form>
        </div>
    </div>

    <!-- 오른쪽 패널 : 뱃지 목록 -->
    <div class="right-panel">
        <div class="panel-card">
            <div class="section-title">
                <h3>뱃지 목록</h3>
            </div>

            <table class="admin-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Icon</th>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody>

                <tr th:each="b : ${badges}">
                    <td th:text="${b.id}"></td>

                    <td class="upload-cell">
                        <img th:if="${b.iconUrl}" th:src="${b.iconUrl}" class="inline-image">
                        <span th:if="${b.iconUrl == null}">-</span>
                    </td>

                    <td th:text="${b.badgeCode}"></td>
                    <td th:text="${b.name}"></td>
                    <td th:text="${b.description}"></td>

                    <td>
                        <div class="action-buttons">
                            <a th:href="@{'/admin/badges?editId=' + ${b.id}}" class="btn-secondary btn-small">
                                수정
                            </a>

                            <form th:action="@{'/admin/badges/' + ${b.id} + '/delete'}"
                                  method="post"
                                  onsubmit="return confirm('정말 삭제하시겠습니까?');">
                                <button class="btn-third btn-small">삭제</button>
                            </form>
                        </div>
                    </td>

                </tr>

                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    window.onload = function () {
        filterFields('entitySelect', 'fieldSelect');
    }
</script>

</body>
</html>
